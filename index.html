<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Bluetooth Fulcanelli</title>
    <style>
        body { background: #000; color: #00FF00; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        .consola { border: 2px solid #00FF00; padding: 25px; background: #010; border-radius: 20px; box-shadow: 0 0 20px #0f0; }
        select { width: 100%; padding: 12px; background: #111; color: #0f0; border: 1px solid #0f0; margin-bottom: 20px; font-size: 14px; }
        #vumetro { width: 100%; height: 30px; background: #020; border: 1px solid #0f0; margin: 15px 0; overflow: hidden; border-radius: 5px; }
        #barra { width: 0%; height: 100%; background: #0f0; transition: width 0.1s; }
        .controles { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 20px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; font-size: 1.1em; text-transform: uppercase; }
        #btn-play { background: #006400; color: #fff; }
        #btn-stop { background: #8B0000; color: #fff; }
        .instruccion { color: #FFD700; font-size: 14px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>SENSOR DE ENTRADA BLUETOOTH</h2>
    <p class="instruccion">1. Conecta tus audífonos Bluetooth al sistema.<br>2. Selecciona el micrófono de los audífonos en la lista:</p>

    <div class="consola">
        <select id="listaDispositivos"><option>Cargando dispositivos...</option></select>
        
        NIVEL SENSORIAL (LEY DE WINTER):
        <div id="vumetro"><div id="barra"></div></div>
        ESTADO: <span id="status" style="color: #f00;">DESCONECTADO</span>
    </div>

    <br>
    <div class="controles">
        <button id="btn-play" class="btn" onclick="activarAudio()">ACTIVAR CANAL</button>
        <button id="btn-stop" class="btn" onclick="detenerAudio()">STOP</button>
    </div>

    <script>
        let aCtx, analista, dataArray, streamLocal;
        const selector = document.getElementById('listaDispositivos');

        // Función para listar micrófonos disponibles
        async function listarMicrofonos() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                const dispositivos = await navigator.mediaDevices.enumerateDevices();
                selector.innerHTML = "";
                dispositivos.filter(d => d.kind === 'audioinput').forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `Micrófono ${selector.length + 1}`;
                    selector.appendChild(opt);
                });
            } catch (err) {
                selector.innerHTML = "<option>Error al detectar hardware</option>";
            }
        }

        async function activarAudio() {
            if (aCtx) aCtx.close();
            aCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const deviceId = selector.value;
            const constraints = {
                audio: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: true
                }
            };

            try {
                streamLocal = await navigator.mediaDevices.getUserMedia(constraints);
                const fuente = aCtx.createMediaStreamSource(streamLocal);
                
                // Filtro Pasa-Bajos (Sintonía Fina 20-100Hz)
                const filtro = aCtx.createBiquadFilter();
                filtro.type = "lowpass";
                filtro.frequency.value = 100;

                const ganancia = aCtx.createGain();
                ganancia.gain.value = 12.0; // Amplificación para latido Bluetooth

                analista = aCtx.createAnalyser();
                analista.fftSize = 256;
                dataArray = new Uint8Array(analista.frequencyBinCount);

                fuente.connect(filtro);
                filtro.connect(ganancia);
                ganancia.connect(analista);
                ganancia.connect(aCtx.destination);

                document.getElementById('status').innerText = "CONECTADO A BLUETOOTH";
                document.getElementById('status').style.color = "#0f0";
                
                actualizarVumetro();
            } catch (err) {
                alert("No se pudo conectar al dispositivo Bluetooth: " + err);
            }
        }

        function detenerAudio() {
            if (streamLocal) streamLocal.getTracks().forEach(t => t.stop());
            if (aCtx) aCtx.close();
            document.getElementById('status').innerText = "DESCONECTADO";
            document.getElementById('status').style.color = "#f00";
            document.getElementById('barra').style.width = "0%";
        }

        function actualizarVumetro() {
            if (aCtx && aCtx.state !== 'closed') {
                analista.getByteFrequencyData(dataArray);
                let promedio = dataArray.reduce((a, b) => a + b) / dataArray.length;
                document.getElementById('barra').style.width = Math.min(100, (promedio * 3)) + "%";
                requestAnimationFrame(actualizarVumetro);
            }
        }

        // Iniciar detección al cargar
        listarMicrofonos();
        // Evitar que la pantalla se apague durante la medición
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen');
        }
    </script>
</body>
</html>