<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA FULCANELLI - ACCESO TOTAL</title>
    <style>
        body { background: #000; color: #00FF00; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        .consola { border: 2px solid #00FF00; padding: 25px; background: #010; border-radius: 20px; }
        select { width: 100%; padding: 15px; background: #111; color: #0f0; border: 1px solid #0f0; margin-bottom: 20px; font-size: 1.1em; }
        #vumetro { width: 100%; height: 35px; background: #020; border: 1px solid #0f0; margin: 15px 0; border-radius: 5px; }
        #barra { width: 0%; height: 100%; background: #0f0; transition: width 0.05s; }
        .btn-accion { padding: 25px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; font-size: 1.2em; width: 100%; margin: 10px 0; text-transform: uppercase; }
        #btn-permiso { background: #FFD700; color: #000; }
        #btn-play { background: #006400; color: #fff; display: none; }
        #btn-stop { background: #8B0000; color: #fff; display: none; }
        .instruccion { color: #FFD700; font-size: 14px; margin-bottom: 15px; border: 1px dashed #FFD700; padding: 10px; }
    </style>
</head>
<body>

    <h2>SENSOR SENSORIAL DE PRECISIÓN</h2>
    
    <div id="guia" class="instruccion">
        <strong>PASO CRÍTICO:</strong><br>
        1. Presiona el botón amarillo para pedir permiso al sistema.<br>
        2. Si aparece una ventana, dale a <strong>"PERMITIR"</strong>.<br>
        3. Selecciona tus audífonos en la lista que aparecerá.
    </div>

    <div class="consola">
        <button id="btn-permiso" class="btn-accion" onclick="pedirPermisoMaestro()">1. SOLICITAR PERMISO DE HARDWARE</button>
        
        <select id="listaDispositivos" style="display:none;"><option value="">Seleccionando dispositivo...</option></select>
        
        <div id="display-señal" style="display:none;">
            NIVEL DE SEÑAL (MANÓMETRO):
            <div id="vumetro"><div id="barra"></div></div>
            ESTADO: <span id="status" style="color: #0f0;">SISTEMA LISTO</span>
        </div>

        <button id="btn-play" class="btn-accion" onclick="activarCanal()">2. INICIAR ESCUCHA (PLAY)</button>
        <button id="btn-stop" class="btn-accion" onclick="detenerSistema()">PARAR (STOP)</button>
    </div>

    <script>
        let audioContext, analista, dataArray, streamGlobal;

        async function pedirPermisoMaestro() {
            try {
                // Intento de apertura directa
                streamGlobal = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Si llegamos aquí, tenemos permiso. Listamos dispositivos:
                const dispositivos = await navigator.mediaDevices.enumerateDevices();
                const selector = document.getElementById('listaDispositivos');
                selector.innerHTML = "";

                dispositivos.filter(d => d.kind === 'audioinput').forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `Entrada Bluetooth/Micro (${selector.length + 1})`;
                    selector.appendChild(opt);
                });

                // Cambiar interfaz
                document.getElementById('btn-permiso').style.display = 'none';
                document.getElementById('listaDispositivos').style.display = 'block';
                document.getElementById('btn-play').style.display = 'block';
                document.getElementById('display-señal').style.display = 'block';
                document.getElementById('guia').innerText = "DISPOSITIVO DETECTADO. ELIGE TUS AUDÍFONOS Y DALE A PLAY.";

            } catch (err) {
                alert("EL SISTEMA BLOQUEÓ EL ACCESO.\n\nVe a los ajustes de tu navegador o teléfono y activa el permiso de micrófono para esta página.");
            }
        }

        async function activarCanal() {
            const deviceId = document.getElementById('listaDispositivos').value;
            
            // Cerramos cualquier flujo previo antes de abrir el nuevo
            if (streamGlobal) streamGlobal.getTracks().forEach(t => t.stop());

            try {
                streamGlobal = await navigator.mediaDevices.getUserMedia({
                    audio: { deviceId: { ideal: deviceId } }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const fuente = audioContext.createMediaStreamSource(streamGlobal);
                
                analista = audioContext.createAnalyser();
                analista.fftSize = 256;
                dataArray = new Uint8Array(analista.frequencyBinCount);

                // Ganancia extrema para sensor Bluetooth
                const ganancia = audioContext.createGain();
                ganancia.gain.value = 15.0;

                fuente.connect(ganancia);
                ganancia.connect(analista);
                ganancia.connect(audioContext.destination);

                document.getElementById('btn-play').style.display = 'none';
                document.getElementById('btn-stop').style.display = 'block';
                
                cicloVumetro();
            } catch (err) {
                alert("Error al conectar con el sensor: " + err);
            }
        }

        function detenerSistema() {
            if (streamGlobal) streamGlobal.getTracks().forEach(t => t.stop());
            if (audioContext) audioContext.close();
            
            document.getElementById('btn-play').style.display = 'block';
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('barra').style.width = "0%";
        }

        function cicloVumetro() {
            if (audioContext && audioContext.state !== 'closed') {
                analista.getByteFrequencyData(dataArray);
                let promedio = dataArray.reduce((a, b) => a + b) / dataArray.length;
                document.getElementById('barra').style.width = Math.min(100, (promedio * 3.8)) + "%";
                requestAnimationFrame(cicloVumetro);
            }
        }

        // Obligatorio para el Manómetro: No apagar pantalla
        if ('wakeLock' in navigator) { navigator.wakeLock.request('screen'); }
    </script>
</body>
</html>
